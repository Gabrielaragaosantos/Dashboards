<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reengenharia de Disciplinas | UNILA Campus Arandu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0D0D0D;
            --bg-secondary: #1A1A1A;
            --bg-card: #242424;
            --border-color: #3D3D3D;
            --text-primary: #F5F5F5;
            --text-secondary: #B8B8B8;
            --text-muted: #808080;
            --accent-orange: #FF6B00;
            --accent-yellow: #FFB800;
            --accent-brown: #8B4513;
            --accent-terracotta: #C65D07;
            --grid-line: rgba(255, 107, 0, 0.08);
            --hvac-color: #FF6B00;
            --hid-color: #00A8CC;
            --esg-color: #FFB800;
            --spr-color: #FF3D00;
            --inc-color: #E91E63;
            --ele-color: #9C27B0;
            --status-pending: #606060;
            --status-progress: #FFB800;
            --status-issues: #FF6B00;
            --status-approved: #4CAF50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: -1px -1px;
        }

        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--bg-primary);
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);
        }

        .logo-text h1 {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(90deg, var(--accent-yellow), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--border-color);
            border-color: var(--accent-orange);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-terracotta));
            border: none;
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.25);
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-report {
            background: linear-gradient(135deg, #2196F3, #1565C0);
            border: none;
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.25);
        }

        .btn-report:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .main-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-yellow));
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-orange);
            box-shadow: 0 8px 30px rgba(255, 107, 0, 0.15);
        }

        .stat-card.progress-card::before { background: var(--status-progress); }
        .stat-card.issues-card::before { background: var(--status-issues); }
        .stat-card.approved-card::before { background: var(--status-approved); }

        .stat-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-value span {
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .building-section { margin-bottom: 3rem; }

        .building-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            border-left: 4px solid var(--accent-orange);
        }

        .building-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-yellow);
        }

        .building-header .building-progress {
            margin-left: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .building-header .building-progress strong {
            color: var(--accent-orange);
            font-size: 1.1rem;
        }

        .disciplines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 520px) {
            .disciplines-grid { grid-template-columns: 1fr; }
        }

        .discipline-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .discipline-card:hover {
            border-color: var(--accent-orange);
            box-shadow: 0 10px 40px rgba(255, 107, 0, 0.15);
        }

        .card-header {
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .card-header::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .discipline-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .discipline-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            letter-spacing: 1px;
        }

        .discipline-name h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }

        .discipline-name span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .card-progress { text-align: right; }

        .progress-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .progress-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .phases-container { padding: 1.25rem; }

        .phases-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .phases-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
        }

        .phase-counter {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .phases-timeline {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .phase-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid transparent;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .phase-item:hover {
            border-color: var(--border-color);
            background: var(--bg-primary);
        }

        .phase-status {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .phase-status.pending { background: var(--status-pending); }
        .phase-status.progress {
            background: var(--status-progress);
            box-shadow: 0 0 10px rgba(255, 184, 0, 0.4);
            animation: pulse 2s infinite;
        }
        .phase-status.issues {
            background: var(--status-issues);
            box-shadow: 0 0 10px rgba(255, 107, 0, 0.4);
            animation: pulse 1.5s infinite;
        }
        .phase-status.approved { background: var(--status-approved); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .phase-status svg {
            width: 14px;
            height: 14px;
            stroke: var(--bg-primary);
            stroke-width: 2.5;
            fill: none;
        }

        .phase-content { flex: 1; min-width: 0; }

        .phase-name {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.1rem;
            color: var(--text-primary);
        }

        .phase-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .phase-status-select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.35rem 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .phase-status-select:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        .phase-status-select option {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        .phase-status-select.pending { border-color: var(--status-pending); }
        .phase-status-select.progress { border-color: var(--status-progress); background: rgba(255, 184, 0, 0.1); }
        .phase-status-select.issues { border-color: var(--status-issues); background: rgba(255, 107, 0, 0.1); }
        .phase-status-select.approved { border-color: var(--status-approved); background: rgba(76, 175, 80, 0.1); }

        .card-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .footer-row { display: flex; gap: 0.75rem; }
        .footer-field { flex: 1; }

        .footer-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 0.35rem;
        }

        .footer-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            transition: border-color 0.2s ease;
        }

        .footer-input:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        .footer-input::placeholder { color: var(--text-muted); }
        .notes-input { resize: vertical; min-height: 60px; }

        .card-timestamp {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: right;
        }

        .footer-info {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--accent-yellow);
        }

        .footer-section p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--status-approved);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .toast.show { transform: translateY(0); opacity: 1; }

        .toast-icon {
            width: 24px;
            height: 24px;
            background: var(--status-approved);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-icon svg {
            width: 14px;
            height: 14px;
            stroke: var(--bg-primary);
            stroke-width: 3;
        }

        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .main-content { padding: 1rem; }
            .stat-value { font-size: 2rem; }
            .phases-container { padding: 1rem; }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-orange); }

        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .card-hvac .card-header::before { background: var(--hvac-color); }
        .card-hvac .discipline-code { background: rgba(255, 107, 0, 0.2); color: var(--hvac-color); }
        .card-hvac .progress-value { color: var(--hvac-color); }
        .card-hvac .progress-bar { background: var(--hvac-color); }

        .card-hid .card-header::before { background: var(--hid-color); }
        .card-hid .discipline-code { background: rgba(0, 168, 204, 0.2); color: var(--hid-color); }
        .card-hid .progress-value { color: var(--hid-color); }
        .card-hid .progress-bar { background: var(--hid-color); }

        .card-esg .card-header::before { background: var(--esg-color); }
        .card-esg .discipline-code { background: rgba(255, 184, 0, 0.2); color: var(--esg-color); }
        .card-esg .progress-value { color: var(--esg-color); }
        .card-esg .progress-bar { background: var(--esg-color); }

        .card-spr .card-header::before { background: var(--spr-color); }
        .card-spr .discipline-code { background: rgba(255, 61, 0, 0.2); color: var(--spr-color); }
        .card-spr .progress-value { color: var(--spr-color); }
        .card-spr .progress-bar { background: var(--spr-color); }

        .card-inc .card-header::before { background: var(--inc-color); }
        .card-inc .discipline-code { background: rgba(233, 30, 99, 0.2); color: var(--inc-color); }
        .card-inc .progress-value { color: var(--inc-color); }
        .card-inc .progress-bar { background: var(--inc-color); }

        .card-ele .card-header::before { background: var(--ele-color); }
        .card-ele .discipline-code { background: rgba(156, 39, 176, 0.2); color: var(--ele-color); }
        .card-ele .progress-value { color: var(--ele-color); }
        .card-ele .progress-bar { background: var(--ele-color); }

        .revision-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 107, 0, 0.1);
            border: 1px solid rgba(255, 107, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .revision-info svg {
            width: 16px;
            height: 16px;
            stroke: var(--accent-orange);
            flex-shrink: 0;
        }

        .revision-info span {
            font-size: 0.75rem;
            color: var(--accent-orange);
        }

        .revision-count {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }

        .revision-edit-btn {
            margin-left: auto;
            background: transparent;
            border: 1px solid rgba(255, 107, 0, 0.5);
            border-radius: 4px;
            padding: 0.2rem 0.4rem;
            color: var(--accent-orange);
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            transition: all 0.2s ease;
        }

        .revision-edit-btn:hover { background: rgba(255, 107, 0, 0.2); }

        .revision-input {
            width: 50px;
            padding: 0.2rem 0.4rem;
            background: var(--bg-primary);
            border: 1px solid var(--accent-orange);
            border-radius: 4px;
            color: var(--accent-orange);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
        }

        .revision-input:focus { outline: none; }

        .building-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .building-tab {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .building-tab:hover {
            border-color: var(--accent-orange);
            color: var(--text-primary);
        }

        .building-tab.active {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-terracotta));
            border-color: transparent;
            color: var(--text-primary);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">UN</div>
                <div class="logo-text">
                    <h1>Reengenharia de Disciplinas</h1>
                    <span>UNILA ‚Ä¢ Campus Arandu</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-report" onclick="openReport()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    Relat√≥rio
                </button>
                <button class="btn btn-primary" onclick="saveAllData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Salvar
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-label">Progresso Geral</div>
                <div class="stat-value" id="overallProgress">0<span>%</span></div>
            </div>
            <div class="stat-card progress-card">
                <div class="stat-label">Em Andamento</div>
                <div class="stat-value" id="inProgressCount">0</div>
            </div>
            <div class="stat-card issues-card">
                <div class="stat-label">Com Pend√™ncias</div>
                <div class="stat-value" id="issuesCount">0</div>
            </div>
            <div class="stat-card approved-card">
                <div class="stat-label">Liberados</div>
                <div class="stat-value" id="approvedCount">0</div>
            </div>
        </div>

        <div class="building-filter" id="buildingFilter"></div>
        <div id="buildingsContainer"></div>

        <div class="footer-info">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3>Legenda de Status</h3>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--status-pending)"></div>
                        <span>Pendente - Aguardando in√≠cio</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--status-progress)"></div>
                        <span>Em Andamento - Em execu√ß√£o</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--status-issues)"></div>
                        <span>Com Pend√™ncias - Retorno ao projetista</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--status-approved)"></div>
                        <span>Conclu√≠do - Fase finalizada</span>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Instru√ß√µes</h3>
                    <p>Selecione o status de cada fase no dropdown. O ciclo de revis√£o √© incrementado quando: Reengenharia "Em Andamento" + IFC "Conclu√≠do" + Pranchas "Conclu√≠do". Clique em "Editar" para ajustar manualmente.</p>
                </div>
            </div>
        </div>
    </main>

    <div class="toast" id="toast">
        <div class="toast-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
        </div>
        <span id="toastMessage">Dados salvos com sucesso!</span>
    </div>

    <script>
        const buildings = [
            { id: 'salas', name: 'Bloco de Salas de Aula' },
            { id: 'central', name: 'Edif√≠cio Central/ADM' },
            { id: 'restaurante', name: 'Restaurante/Biblioteca' },
            { id: 'utilidades', name: 'Central de Utilidades / Galerias' }
        ];

        const disciplineTemplates = [
            { id: 'hvac', code: 'ARC', name: 'HVAC', fullName: 'Ar Condicionado e Ventila√ß√£o' },
            { id: 'hid', code: 'HID', name: 'Hidr√°ulica', fullName: 'Instala√ß√µes Hidr√°ulicas' },
            { id: 'esg', code: 'ESG', name: 'Esgoto', fullName: 'Instala√ß√µes de Esgoto' },
            { id: 'spr', code: 'SPR', name: 'Sprinklers', fullName: 'Sistema de Sprinklers' },
            { id: 'inc', code: 'INC', name: 'Hidrantes', fullName: 'Sistema de Hidrantes' },
            { id: 'ele', code: 'ELE', name: 'El√©trica', fullName: 'Instala√ß√µes El√©tricas' }
        ];

        const phaseTemplates = [
            { id: 'reengineering', name: 'Projeto em Reengenharia', description: 'Projetista ajustando o modelo' },
            { id: 'ifc_delivered', name: 'IFC Entregue', description: 'Modelo enviado para compatibiliza√ß√£o' },
            { id: 'compatibility', name: 'Em Compatibiliza√ß√£o', description: 'Analisando interfer√™ncias' },
            { id: 'drawings', name: 'Pranchas Geradas', description: 'Documenta√ß√£o t√©cnica elaborada' },
            { id: 'released', name: 'Liberado para Obra', description: 'Aprovado e liberado para execu√ß√£o' }
        ];

        function generateInitialData() {
            const data = {};
            buildings.forEach(building => {
                data[building.id] = {
                    name: building.name,
                    disciplines: disciplineTemplates.map(disc => ({
                        ...disc,
                        responsible: '',
                        notes: '',
                        lastUpdate: null,
                        revisionCount: 0,
                        _lastCycleState: null,
                        phases: phaseTemplates.map(phase => ({
                            ...phase,
                            status: 'pending'
                        }))
                    }))
                };
            });
            return data;
        }

        let projectData = {};
        let activeBuilding = 'all';
        const STORAGE_KEY = 'unila-reengenharia-data-v4';

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    const initial = generateInitialData();
                    Object.keys(initial).forEach(buildingId => {
                        if (!parsed[buildingId]) {
                            parsed[buildingId] = initial[buildingId];
                        } else {
                            parsed[buildingId].name = initial[buildingId].name;
                            parsed[buildingId].disciplines = initial[buildingId].disciplines.map(initDisc => {
                                const savedDisc = parsed[buildingId].disciplines?.find(d => d.id === initDisc.id);
                                if (savedDisc) {
                                    return {
                                        ...initDisc,
                                        ...savedDisc,
                                        phases: initDisc.phases.map((phase, idx) => ({
                                            ...phase,
                                            status: savedDisc.phases?.[idx]?.status || 'pending'
                                        }))
                                    };
                                }
                                return initDisc;
                            });
                        }
                    });
                    projectData = parsed;
                } catch (e) {
                    projectData = generateInitialData();
                }
            } else {
                projectData = generateInitialData();
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function saveAllData() {
            saveData();
            showToast('Dados salvos com sucesso!');
        }

        function calculateProgress(discipline) {
            const completed = discipline.phases.filter(p => p.status === 'approved').length;
            return Math.round((completed / discipline.phases.length) * 100);
        }

        function calculateBuildingProgress(buildingId) {
            const building = projectData[buildingId];
            if (!building) return 0;
            let total = 0;
            building.disciplines.forEach(d => { total += calculateProgress(d); });
            return Math.round(total / building.disciplines.length);
        }

        function updateStats() {
            let totalProgress = 0;
            let inProgress = 0;
            let issues = 0;
            let approved = 0;
            let buildingCount = 0;

            Object.keys(projectData).forEach(buildingId => {
                const building = projectData[buildingId];
                buildingCount++;
                building.disciplines.forEach(d => {
                    totalProgress += calculateProgress(d);
                    d.phases.forEach(p => {
                        if (p.status === 'progress') inProgress++;
                        if (p.status === 'issues') issues++;
                        if (p.status === 'approved') approved++;
                    });
                });
            });

            const totalDisciplines = buildingCount * disciplineTemplates.length;
            document.getElementById('overallProgress').innerHTML = 
                `${Math.round(totalProgress / totalDisciplines)}<span>%</span>`;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('issuesCount').textContent = issues;
            document.getElementById('approvedCount').textContent = approved;
        }

        function checkRevisionCycle(buildingId, disciplineId) {
            const discipline = projectData[buildingId].disciplines.find(d => d.id === disciplineId);
            if (!discipline) return;

            const reengineering = discipline.phases.find(p => p.id === 'reengineering');
            const ifc = discipline.phases.find(p => p.id === 'ifc_delivered');
            const drawings = discipline.phases.find(p => p.id === 'drawings');

            // Novo ciclo: Reengenharia "Em Andamento" + IFC "Conclu√≠do" + Pranchas "Conclu√≠do"
            if (reengineering?.status === 'progress' && 
                ifc?.status === 'approved' && 
                drawings?.status === 'approved') {
                
                const currentCycle = `${reengineering.status}-${ifc.status}-${drawings.status}`;
                const lastCycle = discipline._lastCycleState;
                
                if (lastCycle !== currentCycle) {
                    discipline.revisionCount = (discipline.revisionCount || 0) + 1;
                    discipline._lastCycleState = currentCycle;
                    return true;
                }
            } else {
                // Reset do estado quando sai da condi√ß√£o
                if (discipline._lastCycleState && 
                    !(reengineering?.status === 'progress' && 
                      ifc?.status === 'approved' && 
                      drawings?.status === 'approved')) {
                    discipline._lastCycleState = null;
                }
            }
            return false;
        }

        function updatePhaseStatus(buildingId, disciplineId, phaseIndex, newStatus) {
            const discipline = projectData[buildingId].disciplines.find(d => d.id === disciplineId);
            if (!discipline) return;

            discipline.phases[phaseIndex].status = newStatus;
            discipline.lastUpdate = new Date().toISOString();

            checkRevisionCycle(buildingId, disciplineId);

            saveData();
            render();
        }

        function updateResponsible(buildingId, disciplineId, value) {
            const discipline = projectData[buildingId].disciplines.find(d => d.id === disciplineId);
            if (discipline) {
                discipline.responsible = value;
                discipline.lastUpdate = new Date().toISOString();
                saveData();
            }
        }

        function updateNotes(buildingId, disciplineId, value) {
            const discipline = projectData[buildingId].disciplines.find(d => d.id === disciplineId);
            if (discipline) {
                discipline.notes = value;
                discipline.lastUpdate = new Date().toISOString();
                saveData();
            }
        }

        function editRevisionCount(buildingId, disciplineId) {
            const discipline = projectData[buildingId].disciplines.find(d => d.id === disciplineId);
            if (!discipline) return;

            const container = document.getElementById(`revision-${buildingId}-${disciplineId}`);
            const currentCount = discipline.revisionCount || 0;
            
            container.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                <span>Ciclos de revis√£o:</span>
                <input type="number" class="revision-input" value="${currentCount}" min="0" 
                    onchange="saveRevisionCount('${buildingId}', '${disciplineId}', this.value)"
                    onkeypress="if(event.key==='Enter') this.blur()"
                    autofocus>
            `;
            container.querySelector('input').focus();
        }

        function saveRevisionCount(buildingId, disciplineId, value) {
            const discipline = projectData[buildingId].disciplines.find(d => d.id === disciplineId);
            if (discipline) {
                discipline.revisionCount = Math.max(0, parseInt(value) || 0);
                discipline.lastUpdate = new Date().toISOString();
                saveData();
                render();
            }
        }

        function formatDate(isoString) {
            if (!isoString) return 'Nunca atualizado';
            const date = new Date(isoString);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'approved':
                    return '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
                case 'progress':
                    return '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/></svg>';
                case 'issues':
                    return '<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
                default:
                    return '';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Pendente';
                case 'progress': return 'Em Andamento';
                case 'issues': return 'Pend√™ncias';
                case 'approved': return 'Conclu√≠do';
                default: return status;
            }
        }

        function setActiveBuilding(buildingId) {
            activeBuilding = buildingId;
            render();
        }

        // Fun√ß√£o para gerar e abrir relat√≥rio
        function openReport() {
            const reportWindow = window.open('', '_blank', 'width=1200,height=800');
            const now = new Date().toLocaleString('pt-BR');
            
            let totalProgress = 0;
            let totalDisciplines = 0;
            let inProgress = 0;
            let issues = 0;
            let approved = 0;

            Object.keys(projectData).forEach(buildingId => {
                const building = projectData[buildingId];
                building.disciplines.forEach(d => {
                    totalDisciplines++;
                    totalProgress += calculateProgress(d);
                    d.phases.forEach(p => {
                        if (p.status === 'progress') inProgress++;
                        if (p.status === 'issues') issues++;
                        if (p.status === 'approved') approved++;
                    });
                });
            });

            const overallProgress = Math.round(totalProgress / totalDisciplines);

            let buildingsHtml = '';
            buildings.forEach(building => {
                const buildingData = projectData[building.id];
                if (!buildingData) return;

                const buildingProgress = calculateBuildingProgress(building.id);

                buildingsHtml += `
                    <div class="building-section">
                        <h2>üè¢ ${building.name} <span class="progress-badge">${buildingProgress}%</span></h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Disciplina</th>
                                    <th>Projetista</th>
                                    <th>Progresso</th>
                                    <th>Revis√µes</th>
                                    <th>Status das Fases</th>
                                    <th>Observa√ß√µes</th>
                                    <th>√öltima Atualiza√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                buildingData.disciplines.forEach(disc => {
                    const progress = calculateProgress(disc);
                    const phasesStatus = disc.phases.map(p => {
                        const statusClass = p.status;
                        const statusText = getStatusText(p.status);
                        return `<span class="phase-badge ${statusClass}" title="${p.name}">${p.name.split(' ')[0]}: ${statusText}</span>`;
                    }).join('');

                    buildingsHtml += `
                        <tr>
                            <td><strong>${disc.code}</strong> - ${disc.fullName}</td>
                            <td>${disc.responsible || '<em>N√£o definido</em>'}</td>
                            <td><div class="progress-cell"><div class="mini-progress"><div class="mini-bar" style="width: ${progress}%"></div></div> ${progress}%</div></td>
                            <td class="center">${disc.revisionCount || 0}</td>
                            <td class="phases-cell">${phasesStatus}</td>
                            <td class="notes-cell">${disc.notes || '-'}</td>
                            <td class="date-cell">${formatDate(disc.lastUpdate)}</td>
                        </tr>
                    `;
                });

                buildingsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            const reportHtml = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio de Progresso - UNILA Campus Arandu</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            background: linear-gradient(135deg, #FF6B00, #C65D07);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .header .subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }
        .header .date {
            margin-top: 1rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        .summary-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FF6B00;
        }
        .summary-card .label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .summary-card.progress .value { color: #FFB800; }
        .summary-card.issues .value { color: #FF6B00; }
        .summary-card.approved .value { color: #4CAF50; }
        .building-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .building-section h2 {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #FF6B00;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .progress-badge {
            background: #FF6B00;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            background: #f8f8f8;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eee;
        }
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        tr:hover { background: #fafafa; }
        .progress-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .mini-progress {
            width: 60px;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        .mini-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF6B00, #FFB800);
            border-radius: 4px;
        }
        .center { text-align: center; }
        .phases-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .phase-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            white-space: nowrap;
        }
        .phase-badge.pending { background: #e0e0e0; color: #666; }
        .phase-badge.progress { background: #fff3cd; color: #856404; }
        .phase-badge.issues { background: #ffe5d0; color: #C65D07; }
        .phase-badge.approved { background: #d4edda; color: #155724; }
        .notes-cell {
            max-width: 200px;
            font-size: 0.8rem;
            color: #666;
        }
        .date-cell {
            font-size: 0.8rem;
            color: #888;
            white-space: nowrap;
        }
        .footer {
            text-align: center;
            padding: 2rem;
            color: #888;
            font-size: 0.85rem;
        }
        @media print {
            body { background: white; }
            .container { padding: 0; }
            .building-section { box-shadow: none; border: 1px solid #ddd; }
        }
        .btn-print {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #FF6B00;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3);
        }
        .btn-print:hover { background: #e55f00; }
        @media print { .btn-print { display: none; } }
    </style>
</head>
<body>
    <button class="btn-print" onclick="window.print()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 6 2 18 2 18 9"/>
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
            <rect x="6" y="14" width="12" height="8"/>
        </svg>
        Imprimir
    </button>

    <div class="container">
        <div class="header">
            <h1>üìä Relat√≥rio de Progresso - Reengenharia de Disciplinas</h1>
            <div class="subtitle">UNILA Campus Arandu</div>
            <div class="date">Gerado em: ${now}</div>
        </div>

        <div class="summary">
            <div class="summary-card">
                <div class="value">${overallProgress}%</div>
                <div class="label">Progresso Geral</div>
            </div>
            <div class="summary-card progress">
                <div class="value">${inProgress}</div>
                <div class="label">Em Andamento</div>
            </div>
            <div class="summary-card issues">
                <div class="value">${issues}</div>
                <div class="label">Com Pend√™ncias</div>
            </div>
            <div class="summary-card approved">
                <div class="value">${approved}</div>
                <div class="label">Liberados</div>
            </div>
        </div>

        ${buildingsHtml}

        <div class="footer">
            <p>Relat√≥rio gerado automaticamente pelo Sistema de Controle de Reengenharia - UNILA Campus Arandu</p>
            <p>Cons√≥rcio MPD/Ankara</p>
        </div>
    </div>
</body>
</html>
            `;

            reportWindow.document.write(reportHtml);
            reportWindow.document.close();
        }

        function renderBuildingTabs() {
            const container = document.getElementById('buildingFilter');
            let html = `<button class="building-tab ${activeBuilding === 'all' ? 'active' : ''}" onclick="setActiveBuilding('all')">Todos</button>`;
            
            buildings.forEach(building => {
                html += `<button class="building-tab ${activeBuilding === building.id ? 'active' : ''}" onclick="setActiveBuilding('${building.id}')">${building.name}</button>`;
            });
            
            container.innerHTML = html;
        }

        function renderBuildings() {
            const container = document.getElementById('buildingsContainer');
            let html = '';

            const buildingsToRender = activeBuilding === 'all' 
                ? buildings 
                : buildings.filter(b => b.id === activeBuilding);

            buildingsToRender.forEach((building, buildingIndex) => {
                const buildingData = projectData[building.id];
                if (!buildingData) return;

                const buildingProgress = calculateBuildingProgress(building.id);

                html += `
                    <div class="building-section">
                        <div class="building-header">
                            <h2>üè¢ ${building.name}</h2>
                            <div class="building-progress">
                                Progresso: <strong>${buildingProgress}%</strong>
                            </div>
                        </div>
                        <div class="disciplines-grid">
                `;

                buildingData.disciplines.forEach((discipline, disciplineIndex) => {
                    const progress = calculateProgress(discipline);
                    const completedPhases = discipline.phases.filter(p => p.status === 'approved').length;
                    const revisionCount = discipline.revisionCount || 0;

                    html += `
                        <div class="discipline-card card-${discipline.id}" style="animation-delay: ${(buildingIndex * 6 + disciplineIndex) * 0.05}s">
                            <div class="card-header">
                                <div class="discipline-info">
                                    <span class="discipline-code">${discipline.code}</span>
                                    <div class="discipline-name">
                                        <h3>${discipline.name}</h3>
                                        <span>${discipline.fullName}</span>
                                    </div>
                                </div>
                                <div class="card-progress">
                                    <div class="progress-value">${progress}%</div>
                                    <div class="progress-label">Progresso</div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="phases-container">
                                <div class="phases-header">
                                    <span class="phases-title">Fases do Projeto</span>
                                    <span class="phase-counter">${completedPhases}/${discipline.phases.length} conclu√≠das</span>
                                </div>

                                <div class="revision-info" id="revision-${building.id}-${discipline.id}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="23 4 23 10 17 10"/>
                                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                    </svg>
                                    <span>Ciclos de revis√£o: <span class="revision-count">${revisionCount}</span></span>
                                    <button class="revision-edit-btn" onclick="editRevisionCount('${building.id}', '${discipline.id}')">Editar</button>
                                </div>

                                <div class="phases-timeline">
                                    ${discipline.phases.map((phase, phaseIndex) => `
                                        <div class="phase-item">
                                            <div class="phase-status ${phase.status}">
                                                ${getStatusIcon(phase.status)}
                                            </div>
                                            <div class="phase-content">
                                                <div class="phase-name">${phase.name}</div>
                                                <div class="phase-desc">${phase.description}</div>
                                            </div>
                                            <select class="phase-status-select ${phase.status}" 
                                                onchange="updatePhaseStatus('${building.id}', '${discipline.id}', ${phaseIndex}, this.value)">
                                                <option value="pending" ${phase.status === 'pending' ? 'selected' : ''}>Pendente</option>
                                                <option value="progress" ${phase.status === 'progress' ? 'selected' : ''}>Em Andamento</option>
                                                <option value="issues" ${phase.status === 'issues' ? 'selected' : ''}>Pend√™ncias</option>
                                                <option value="approved" ${phase.status === 'approved' ? 'selected' : ''}>Conclu√≠do</option>
                                            </select>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="card-footer">
                                <div class="footer-row">
                                    <div class="footer-field">
                                        <div class="footer-label">Projetista Respons√°vel</div>
                                        <input type="text" class="footer-input" 
                                            placeholder="Nome do projetista"
                                            value="${discipline.responsible || ''}"
                                            onchange="updateResponsible('${building.id}', '${discipline.id}', this.value)">
                                    </div>
                                </div>
                                <div class="footer-field">
                                    <div class="footer-label">Observa√ß√µes</div>
                                    <textarea class="footer-input notes-input" 
                                        placeholder="Registre pend√™ncias, interfer√™ncias identificadas, observa√ß√µes..."
                                        onchange="updateNotes('${building.id}', '${discipline.id}', this.value)">${discipline.notes || ''}</textarea>
                                </div>
                                <div class="card-timestamp">
                                    √öltima atualiza√ß√£o: ${formatDate(discipline.lastUpdate)}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function render() {
            renderBuildingTabs();
            renderBuildings();
            updateStats();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            render();
        });
    </script>
</body>
</html>
