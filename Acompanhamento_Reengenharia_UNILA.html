<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reengenharia de Disciplinas | UNILA Campus Arandu</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0D0D0D;
            --bg-secondary: #1A1A1A;
            --bg-card: #242424;
            --border-color: #3D3D3D;
            --text-primary: #F5F5F5;
            --text-secondary: #B8B8B8;
            --text-muted: #808080;
            --accent-orange: #FF6B00;
            --accent-yellow: #FFB800;
            --accent-terracotta: #C65D07;
            --grid-line: rgba(255, 107, 0, 0.08);
            --hvac-color: #FF6B00;
            --hid-color: #00A8CC;
            --esg-color: #FFB800;
            --spr-color: #FF3D00;
            --inc-color: #E91E63;
            --ele-color: #9C27B0;
            --cab-color: #00BCD4;
            --status-pending: #606060;
            --status-progress: #FFB800;
            --status-issues: #FF6B00;
            --status-approved: #4CAF50;
            --mode-color: #2196F3;
            --ajus-color: #9C27B0;
            --reng-color: #FF6B00;
            --asbt-color: #4CAF50;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px); background-size: 50px 50px; }
        .header { background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%); border-bottom: 1px solid var(--border-color); padding: 1.5rem 2rem; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); }
        .header-content { max-width: 1800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo-section { display: flex; align-items: center; gap: 1rem; }
        .logo-img { height: 50px; width: auto; object-fit: contain; border-radius: 8px; }
        .logo-unila { height: 45px; width: auto; object-fit: contain; margin-right: 0.5rem; }
        .logo-text h1 { font-size: 1.4rem; font-weight: 700; background: linear-gradient(90deg, var(--accent-yellow), var(--accent-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text span { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); letter-spacing: 2px; }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        .sync-status { display: flex; align-items: center; gap: 0.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); padding: 0.4rem 0.8rem; background: var(--bg-card); border-radius: 6px; border: 1px solid var(--border-color); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--status-approved); animation: pulse-dot 2s infinite; }
        .sync-dot.offline { background: var(--status-issues); animation: none; }
        .sync-dot.syncing { background: var(--status-progress); animation: pulse-dot 0.5s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 0.6rem 1.2rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem; }
        .btn:hover { background: var(--border-color); border-color: var(--accent-orange); }
        .btn-report { background: linear-gradient(135deg, #2196F3, #1565C0); border: none; font-weight: 600; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.25); }
        .main-content { max-width: 1800px; margin: 0 auto; padding: 2rem; }
        .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; margin-bottom: 2.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 1.5rem; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent-orange), var(--accent-yellow)); }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent-orange); box-shadow: 0 8px 30px rgba(255, 107, 0, 0.15); }
        .stat-card.progress-card::before { background: var(--status-progress); }
        .stat-card.issues-card::before { background: var(--status-issues); }
        .stat-card.approved-card::before { background: var(--status-approved); }
        .stat-label { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 0.5rem; }
        .stat-value { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .stat-value span { font-size: 1.2rem; color: var(--text-muted); }
        .building-section { margin-bottom: 3rem; }
        .building-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem 1.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; border-left: 4px solid var(--accent-orange); flex-wrap: wrap; }
        .building-header h2 { font-size: 1.2rem; font-weight: 600; color: var(--accent-yellow); }
        .building-header .building-progress { margin-left: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-secondary); }
        .building-header .building-progress strong { color: var(--accent-orange); font-size: 1.1rem; }
        .building-config { display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem; padding-left: 1rem; border-left: 1px solid var(--border-color); }
        .building-config label { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); }
        .building-config input { width: 60px; padding: 0.3rem 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; text-align: center; }
        .building-config input:focus { outline: none; border-color: var(--accent-orange); }
        .disciplines-grid { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem; }
        .discipline-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; transition: all 0.3s ease; animation: fadeInUp 0.5s ease forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .discipline-card:hover { border-color: var(--accent-orange); box-shadow: 0 10px 40px rgba(255, 107, 0, 0.15); }
        .card-header { padding: 1.25rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); position: relative; flex-wrap: wrap; gap: 1rem; }
        .card-header::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .discipline-info { display: flex; align-items: center; gap: 1rem; }
        .discipline-code { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; padding: 0.4rem 0.8rem; border-radius: 8px; letter-spacing: 1px; }
        .discipline-name h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.15rem; }
        .discipline-name span { font-size: 0.75rem; color: var(--text-secondary); }
        .reengineering-status { display: flex; align-items: center; gap: 0.75rem; background: var(--bg-secondary); padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); }
        .reengineering-status label { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
        .reengineering-status select { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 0.35rem 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); cursor: pointer; }
        .reengineering-status select:focus { outline: none; border-color: var(--accent-orange); }
        .reengineering-status select.pending { border-color: var(--status-pending); }
        .reengineering-status select.progress { border-color: var(--status-progress); background: rgba(255, 184, 0, 0.1); }
        .reengineering-status select.approved { border-color: var(--status-approved); background: rgba(76, 175, 80, 0.1); }
        .model-types-container { padding: 1.25rem; }
        .model-types-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }
        .model-type-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        .model-type-card.not-applicable { opacity: 0.5; }
        .model-type-header { padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); }
        .model-type-header.mode { background: rgba(33, 150, 243, 0.15); border-left: 3px solid var(--mode-color); }
        .model-type-header.ajus { background: rgba(156, 39, 176, 0.15); border-left: 3px solid var(--ajus-color); }
        .model-type-header.reng { background: rgba(255, 107, 0, 0.15); border-left: 3px solid var(--reng-color); }
        .model-type-header.asbt { background: rgba(76, 175, 80, 0.15); border-left: 3px solid var(--asbt-color); }
        .model-type-title { display: flex; align-items: center; gap: 0.5rem; }
        .model-type-code { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 700; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .model-type-code.mode { background: var(--mode-color); color: white; }
        .model-type-code.ajus { background: var(--ajus-color); color: white; }
        .model-type-code.reng { background: var(--reng-color); color: white; }
        .model-type-code.asbt { background: var(--asbt-color); color: white; }
        .model-type-name { font-size: 0.75rem; color: var(--text-secondary); }
        .na-toggle { display: flex; align-items: center; gap: 0.5rem; }
        .na-toggle label { font-size: 0.7rem; color: var(--text-muted); }
        .na-toggle input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .model-type-content { padding: 0.75rem 1rem; }
        .model-type-content.disabled { pointer-events: none; opacity: 0.4; }
        .projetista-field { margin-bottom: 0.75rem; }
        .projetista-field label { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); display: block; margin-bottom: 0.25rem; }
        .projetista-field input { width: 100%; padding: 0.4rem 0.6rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem; }
        .projetista-field input:focus { outline: none; border-color: var(--accent-orange); }
        
        /* N√≠veis (Pavimentos) */
        .niveis-container { margin-top: 0.75rem; }
        .nivel-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; overflow: hidden; }
        .nivel-header { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0.75rem; background: rgba(255, 107, 0, 0.05); cursor: pointer; }
        .nivel-header:hover { background: rgba(255, 107, 0, 0.1); }
        .nivel-name { display: flex; align-items: center; gap: 0.5rem; }
        .nivel-name input { background: transparent; border: none; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 600; width: 140px; padding: 0.2rem; }
        .nivel-name input:focus { outline: none; background: var(--bg-secondary); border-radius: 3px; }
        .nivel-toggle { font-size: 0.7rem; color: var(--text-muted); transition: transform 0.2s; }
        .nivel-toggle.open { transform: rotate(180deg); }
        .nivel-content { padding: 0.75rem; display: none; border-top: 1px solid var(--border-color); }
        .nivel-content.open { display: block; }
        
        /* Fases - Layout vertical */
        .nivel-phases { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; }
        .nivel-phase { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px; }
        .nivel-phase-name { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; font-weight: 600; color: var(--text-secondary); text-align: center; }
        .nivel-phase select { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; padding: 0.25rem 0.3rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); cursor: pointer; width: 100%; text-align: center; }
        .nivel-phase select:focus { outline: none; border-color: var(--accent-orange); }
        .nivel-phase select.pending { border-color: var(--status-pending); }
        .nivel-phase select.progress { border-color: var(--status-progress); background: rgba(255, 184, 0, 0.15); }
        .nivel-phase select.issues { border-color: var(--status-issues); background: rgba(255, 107, 0, 0.15); }
        .nivel-phase select.approved { border-color: var(--status-approved); background: rgba(76, 175, 80, 0.15); }
        
        /* Observa√ß√µes auto-expans√≠vel */
        .nivel-obs { width: 100%; }
        .nivel-obs label { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); display: block; margin-bottom: 0.25rem; }
        .nivel-obs textarea { 
            width: 100%; 
            padding: 0.4rem; 
            background: var(--bg-secondary); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            color: var(--text-primary); 
            font-size: 0.75rem; 
            font-family: 'Space Grotesk', sans-serif;
            resize: none; 
            min-height: 36px; 
            overflow: hidden;
            line-height: 1.4;
        }
        .nivel-obs textarea:focus { outline: none; border-color: var(--accent-orange); }
        
        .revision-counters { display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color); }
        .revision-counter { flex: 1; display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.5rem; background: rgba(255, 107, 0, 0.08); border: 1px solid rgba(255, 107, 0, 0.2); border-radius: 6px; font-size: 0.65rem; color: var(--accent-orange); }
        .revision-counter svg { width: 12px; height: 12px; stroke: var(--accent-orange); flex-shrink: 0; }
        .revision-counter-label { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .revision-counter-value { font-family: 'JetBrains Mono', monospace; font-weight: 700; margin-left: auto; }
        .revision-counter-edit { background: transparent; border: 1px solid rgba(255, 107, 0, 0.4); border-radius: 3px; padding: 0.1rem 0.3rem; color: var(--accent-orange); cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; margin-left: 0.25rem; }
        .revision-counter-edit:hover { background: rgba(255, 107, 0, 0.2); }
        .revision-counter-input { width: 35px; padding: 0.1rem 0.2rem; background: var(--bg-primary); border: 1px solid var(--accent-orange); border-radius: 3px; color: var(--accent-orange); font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; font-weight: 700; text-align: center; }
        
        .card-footer { padding: 0.75rem 1.25rem; border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: flex-end; }
        .card-timestamp { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-muted); }
        .building-filter { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .building-tab { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 0.6rem 1.2rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; }
        .building-tab:hover { border-color: var(--accent-orange); color: var(--text-primary); }
        .building-tab.active { background: linear-gradient(135deg, var(--accent-orange), var(--accent-terracotta)); border-color: transparent; color: var(--text-primary); font-weight: 600; }
        .footer-info { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem; margin-top: 2rem; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
        .footer-section h3 { font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--accent-yellow); }
        .footer-section p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--bg-card); border: 1px solid var(--status-approved); border-radius: 12px; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1001; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-icon { width: 24px; height: 24px; background: var(--status-approved); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .toast-icon svg { width: 14px; height: 14px; stroke: var(--bg-primary); stroke-width: 3; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent-orange); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-secondary); text-align: center; }
        .author-signature { text-align: center; padding: 2rem; margin-top: 1.5rem; }
        .author-name { font-size: 1rem; font-weight: 600; color: var(--accent-orange); margin-bottom: 0.25rem; }
        .author-email { font-size: 0.9rem; color: var(--accent-orange); text-decoration: none; }
        .author-email:hover { opacity: 0.8; text-decoration: underline; }
        .author-role { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; font-style: italic; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-orange); }
        .card-hvac .card-header::before { background: var(--hvac-color); }
        .card-hvac .discipline-code { background: rgba(255, 107, 0, 0.2); color: var(--hvac-color); }
        .card-hid .card-header::before { background: var(--hid-color); }
        .card-hid .discipline-code { background: rgba(0, 168, 204, 0.2); color: var(--hid-color); }
        .card-esg .card-header::before { background: var(--esg-color); }
        .card-esg .discipline-code { background: rgba(255, 184, 0, 0.2); color: var(--esg-color); }
        .card-spr .card-header::before { background: var(--spr-color); }
        .card-spr .discipline-code { background: rgba(255, 61, 0, 0.2); color: var(--spr-color); }
        .card-inc .card-header::before { background: var(--inc-color); }
        .card-inc .discipline-code { background: rgba(233, 30, 99, 0.2); color: var(--inc-color); }
        .card-ele .card-header::before { background: var(--ele-color); }
        .card-ele .discipline-code { background: rgba(156, 39, 176, 0.2); color: var(--ele-color); }
        .card-cab .card-header::before { background: var(--cab-color); }
        .card-cab .discipline-code { background: rgba(0, 188, 212, 0.2); color: var(--cab-color); }
        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .main-content { padding: 1rem; }
            .stat-value { font-size: 2rem; }
            .model-types-grid { grid-template-columns: 1fr; }
            .nivel-phases { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Conectando ao servidor...</div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="https://raw.githubusercontent.com/Gabrielaragaosantos/Dashboards/main/Imagens%20Salas%20de%20Aulas/logo-consorcio.png" alt="Logo Cons√≥rcio" class="logo-img">
                <div class="logo-text">
                    <h1>Reengenharia de Disciplinas</h1>
                    <span>UNILA ‚Ä¢ Campus Arandu</span>
                </div>
            </div>
            <div class="header-actions">
                <img src="https://raw.githubusercontent.com/Gabrielaragaosantos/Dashboards/main/Imagens%20Salas%20de%20Aulas/Logo_UNILA.png" alt="Logo UNILA" class="logo-unila">
                <div class="sync-status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncText">Conectado</span>
                </div>
                <button class="btn btn-report" onclick="openReport()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Relat√≥rio
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-label">Progresso Geral</div>
                <div class="stat-value" id="overallProgress">0<span>%</span></div>
            </div>
            <div class="stat-card progress-card">
                <div class="stat-label">Em Andamento</div>
                <div class="stat-value" id="inProgressCount">0</div>
            </div>
            <div class="stat-card issues-card">
                <div class="stat-label">Com Pend√™ncias</div>
                <div class="stat-value" id="issuesCount">0</div>
            </div>
            <div class="stat-card approved-card">
                <div class="stat-label">Liberados</div>
                <div class="stat-value" id="approvedCount">0</div>
            </div>
        </div>

        <div class="building-filter" id="buildingFilter"></div>
        <div id="buildingsContainer"></div>

        <div class="footer-info">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3>Tipos de Modelo</h3>
                    <div class="legend-item"><div class="legend-color" style="background: var(--mode-color)"></div><span><strong>MODE</strong> - Modelos originais</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: var(--ajus-color)"></div><span><strong>AJUS</strong> - Ajustes</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: var(--reng-color)"></div><span><strong>RENG</strong> - Reengenharia</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: var(--asbt-color)"></div><span><strong>ASBT</strong> - As Built</span></div>
                </div>
                <div class="footer-section">
                    <h3>Legenda de Status</h3>
                    <div class="legend-item"><div class="legend-color" style="background: var(--status-pending)"></div><span>Pendente</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: var(--status-progress)"></div><span>Em Andamento</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: var(--status-issues)"></div><span>Com Pend√™ncias</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: var(--status-approved)"></div><span>Conclu√≠do</span></div>
                </div>
                <div class="footer-section">
                    <h3>N√≠veis</h3>
                    <p>Cada edifica√ß√£o possui n√≠veis configur√°veis. Clique no nome do n√≠vel para edit√°-lo (ex: Terra√ßo, Cobertura). Os ciclos incrementam quando IFC ou Doc 2D de cada n√≠vel √© conclu√≠do.</p>
                </div>
            </div>
        </div>

        <div class="author-signature">
            <div class="author-name">Gabriel Arag√£o Santos</div>
            <a href="mailto:gabriel.santos@ankaraengenharia.com.br" class="author-email">gabriel.santos@ankaraengenharia.com.br</a>
            <div class="author-role">Arquiteto</div>
        </div>
    </main>

    <div class="toast" id="toast">
        <div class="toast-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></div>
        <span id="toastMessage">Dados sincronizados!</span>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://unila-reengenharia-default-rtdb.firebaseio.com" };
        let firebaseApp, database;
        try { firebaseApp = firebase.initializeApp(firebaseConfig); database = firebase.database(); } 
        catch (e) { document.getElementById('loadingText').textContent = 'Erro Firebase: ' + e.message; }

        const buildings = [
            { id: 'salas', name: 'Bloco de Salas de Aula', defaultLevels: 3 },
            { id: 'central', name: 'Edif√≠cio Central/ADM', defaultLevels: 18 },
            { id: 'restaurante', name: 'Restaurante/Biblioteca', defaultLevels: 1 },
            { id: 'utilidades', name: 'Central de Utilidades / Galerias', defaultLevels: 1 }
        ];

        const disciplineTemplates = [
            { id: 'hvac', code: 'ARC', name: 'HVAC', fullName: 'Ar Condicionado e Ventila√ß√£o' },
            { id: 'hid', code: 'HID', name: 'Hidr√°ulica', fullName: 'Instala√ß√µes Hidr√°ulicas' },
            { id: 'esg', code: 'ESG', name: 'Esgoto', fullName: 'Instala√ß√µes de Esgoto' },
            { id: 'spr', code: 'SPR', name: 'Sprinklers', fullName: 'Sistema de Sprinklers' },
            { id: 'inc', code: 'INC', name: 'Hidrantes', fullName: 'Sistema de Hidrantes' },
            { id: 'ele', code: 'ELE', name: 'El√©trica', fullName: 'Instala√ß√µes El√©tricas' },
            { id: 'cab', code: 'CAB/ESP', name: 'Cabeamentos', fullName: 'Cabeamentos e Especiais' }
        ];

        const modelTypes = [
            { id: 'mode', code: 'MODE', name: 'Modelos Originais', defaultResponsible: 'Alto QI' },
            { id: 'ajus', code: 'AJUS', name: 'Ajustes (NERKPE)', defaultResponsible: '', canBeNA: true },
            { id: 'reng', code: 'RENG', name: 'Reengenharia', defaultResponsible: '', canBeNA: true },
            { id: 'asbt', code: 'ASBT', name: 'As Built', defaultResponsible: '' }
        ];

        const phaseTemplates = ['ifc', 'compatibility', 'docs2d', 'released'];
        const phaseNames = { ifc: 'IFC', compatibility: 'Compatibiliza√ß√£o', docs2d: 'Doc 2D', released: 'Liberado' };

        let projectData = {};
        let activeBuilding = 'salas';

        function generateLevelName(index) {
            if (index === 0) return 'T√©rreo';
            return `${index}¬∫ Pavimento`;
        }

        function generateLevelsData(count) {
            const levels = {};
            for (let i = 0; i < count; i++) {
                levels[`level_${i}`] = {
                    name: generateLevelName(i),
                    order: i,
                    phases: { ifc: 'pending', compatibility: 'pending', docs2d: 'pending', released: 'pending' },
                    obs: ''
                };
            }
            return levels;
        }

        function generateInitialData() {
            const data = {};
            buildings.forEach(building => {
                data[building.id] = { 
                    name: building.name, 
                    levelCount: building.defaultLevels,
                    disciplines: {} 
                };
                disciplineTemplates.forEach(disc => {
                    data[building.id].disciplines[disc.id] = {
                        id: disc.id, code: disc.code, name: disc.name, fullName: disc.fullName,
                        reengineeringStatus: 'pending', lastUpdate: null, modelTypes: {}
                    };
                    modelTypes.forEach(mt => {
                        data[building.id].disciplines[disc.id].modelTypes[mt.id] = {
                            responsible: mt.defaultResponsible,
                            notApplicable: false,
                            revisionCountIfc: 0,
                            revisionCountDocs2d: 0,
                            levels: generateLevelsData(building.defaultLevels)
                        };
                    });
                });
            });
            return data;
        }

        function updateSyncStatus(status) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            if (!dot || !text) return;
            dot.className = 'sync-dot';
            if (status === 'connected') { text.textContent = 'Conectado'; }
            else if (status === 'syncing') { dot.classList.add('syncing'); text.textContent = 'Sincronizando...'; }
            else { dot.classList.add('offline'); text.textContent = 'Offline'; }
        }

        function hideLoading() { 
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none'; 
        }

        async function initializeData() {
            document.getElementById('loadingText').textContent = 'Verificando dados...';
            const snapshot = await database.ref('projectData').once('value');
            if (!snapshot.exists()) {
                document.getElementById('loadingText').textContent = 'Criando estrutura...';
                await database.ref('projectData').set(generateInitialData());
            }
        }

        function setupRealtimeListener() {
            document.getElementById('loadingText').textContent = 'Carregando...';
            database.ref('projectData').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    projectData = snapshot.val();
                    render();
                    updateSyncStatus('connected');
                } else {
                    database.ref('projectData').set(generateInitialData());
                }
                hideLoading();
            }, (error) => {
                document.getElementById('loadingText').innerHTML = 'Erro: ' + error.message + '<br><small>Verifique regras do Firebase</small>';
                updateSyncStatus('offline');
            });
            database.ref('.info/connected').on('value', (s) => updateSyncStatus(s.val() ? 'connected' : 'offline'));
        }

        function updateLevelCount(buildingId, newCount) {
            newCount = Math.max(1, Math.min(50, parseInt(newCount) || 1));
            const building = projectData[buildingId];
            if (!building) return;

            const currentCount = building.levelCount || 1;
            database.ref(`projectData/${buildingId}/levelCount`).set(newCount);

            Object.keys(building.disciplines || {}).forEach(discId => {
                const disc = building.disciplines[discId];
                Object.keys(disc.modelTypes || {}).forEach(mtId => {
                    const mt = disc.modelTypes[mtId];
                    const currentLevels = mt.levels || {};
                    const levelKeys = Object.keys(currentLevels);
                    const actualCurrentCount = levelKeys.length;

                    if (newCount > actualCurrentCount) {
                        for (let i = actualCurrentCount; i < newCount; i++) {
                            database.ref(`projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}/levels/level_${i}`).set({
                                name: generateLevelName(i),
                                order: i,
                                phases: { ifc: 'pending', compatibility: 'pending', docs2d: 'pending', released: 'pending' },
                                obs: ''
                            });
                        }
                    } else if (newCount < actualCurrentCount) {
                        for (let i = newCount; i < actualCurrentCount; i++) {
                            database.ref(`projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}/levels/level_${i}`).remove();
                        }
                    }
                });
            });
        }

        function updateLevelName(buildingId, discId, mtId, levelId, newName) {
            database.ref(`projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}/levels/${levelId}/name`).set(newName);
            database.ref(`projectData/${buildingId}/disciplines/${discId}/lastUpdate`).set(new Date().toISOString());
        }

        function updateLevelPhase(buildingId, discId, mtId, levelId, phase, newStatus) {
            const basePath = `projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}`;
            const mtData = projectData[buildingId]?.disciplines?.[discId]?.modelTypes?.[mtId];
            const oldStatus = mtData?.levels?.[levelId]?.phases?.[phase];

            database.ref(`${basePath}/levels/${levelId}/phases/${phase}`).set(newStatus);
            database.ref(`projectData/${buildingId}/disciplines/${discId}/lastUpdate`).set(new Date().toISOString());

            if (newStatus === 'approved' && oldStatus !== 'approved') {
                if (phase === 'ifc') {
                    database.ref(`${basePath}/revisionCountIfc`).set((mtData?.revisionCountIfc || 0) + 1);
                } else if (phase === 'docs2d') {
                    database.ref(`${basePath}/revisionCountDocs2d`).set((mtData?.revisionCountDocs2d || 0) + 1);
                }
            }
        }

        function updateLevelObs(buildingId, discId, mtId, levelId, obs) {
            database.ref(`projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}/levels/${levelId}/obs`).set(obs);
            database.ref(`projectData/${buildingId}/disciplines/${discId}/lastUpdate`).set(new Date().toISOString());
        }

        function updateReengineeringStatus(buildingId, discId, status) {
            database.ref(`projectData/${buildingId}/disciplines/${discId}`).update({
                reengineeringStatus: status, lastUpdate: new Date().toISOString()
            });
        }

        function updateResponsible(buildingId, discId, mtId, value) {
            database.ref(`projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}/responsible`).set(value);
            database.ref(`projectData/${buildingId}/disciplines/${discId}/lastUpdate`).set(new Date().toISOString());
        }

        function toggleNotApplicable(buildingId, discId, mtId, isNA) {
            database.ref(`projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}/notApplicable`).set(isNA);
            database.ref(`projectData/${buildingId}/disciplines/${discId}/lastUpdate`).set(new Date().toISOString());
        }

        function toggleNivel(id) {
            const el = document.getElementById(id);
            const toggle = document.getElementById(id + '-toggle');
            if (el) {
                el.classList.toggle('open');
                if (toggle) toggle.classList.toggle('open');
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function editRevisionCount(buildingId, discId, mtId, type) {
            const mtData = projectData[buildingId]?.disciplines?.[discId]?.modelTypes?.[mtId];
            if (!mtData) return;
            const containerId = `revision-${type}-${buildingId}-${discId}-${mtId}`;
            const container = document.getElementById(containerId);
            if (!container) return;
            const currentCount = type === 'ifc' ? (mtData.revisionCountIfc || 0) : (mtData.revisionCountDocs2d || 0);
            const label = type === 'ifc' ? 'IFC' : 'Doc 2D';
            container.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg><span class="revision-counter-label">${label}:</span><input type="number" class="revision-counter-input" value="${currentCount}" min="0" onchange="saveRevisionCount('${buildingId}', '${discId}', '${mtId}', '${type}', this.value)" onkeypress="if(event.key==='Enter') this.blur()">`;
            container.querySelector('input').focus();
        }

        function saveRevisionCount(buildingId, discId, mtId, type, value) {
            const field = type === 'ifc' ? 'revisionCountIfc' : 'revisionCountDocs2d';
            database.ref(`projectData/${buildingId}/disciplines/${discId}/modelTypes/${mtId}/${field}`).set(Math.max(0, parseInt(value) || 0));
            database.ref(`projectData/${buildingId}/disciplines/${discId}/lastUpdate`).set(new Date().toISOString());
        }

        function calculateProgress(building) {
            if (!building?.disciplines) return 0;
            let total = 0, completed = 0;
            Object.values(building.disciplines).forEach(disc => {
                Object.values(disc.modelTypes || {}).forEach(mt => {
                    if (!mt.notApplicable && mt.levels) {
                        Object.values(mt.levels).forEach(level => {
                            Object.values(level.phases || {}).forEach(status => {
                                total++;
                                if (status === 'approved') completed++;
                            });
                        });
                    }
                });
            });
            return total > 0 ? Math.round((completed / total) * 100) : 0;
        }

        function updateStats() {
            let totalProgress = 0, buildingCount = 0, inProgress = 0, issues = 0, approved = 0;
            Object.values(projectData).forEach(building => {
                if (!building?.disciplines) return;
                buildingCount++;
                totalProgress += calculateProgress(building);
                Object.values(building.disciplines).forEach(disc => {
                    Object.values(disc.modelTypes || {}).forEach(mt => {
                        if (!mt.notApplicable && mt.levels) {
                            Object.values(mt.levels).forEach(level => {
                                Object.values(level.phases || {}).forEach(status => {
                                    if (status === 'progress') inProgress++;
                                    if (status === 'issues') issues++;
                                    if (status === 'approved') approved++;
                                });
                            });
                        }
                    });
                });
            });
            document.getElementById('overallProgress').innerHTML = `${buildingCount > 0 ? Math.round(totalProgress / buildingCount) : 0}<span>%</span>`;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('issuesCount').textContent = issues;
            document.getElementById('approvedCount').textContent = approved;
        }

        function formatDate(isoString) {
            if (!isoString) return 'Nunca atualizado';
            return new Date(isoString).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function getStatusText(status) {
            return { pending: 'Pendente', progress: 'Em Andamento', issues: 'Pend√™ncias', approved: 'Conclu√≠do' }[status] || status;
        }

        function setActiveBuilding(buildingId) { activeBuilding = buildingId; render(); }

        function openReport() {
            const rw = window.open('', '_blank', 'width=1400,height=900');
            const now = new Date().toLocaleString('pt-BR');
            let bh = '';
            
            buildings.forEach(b => {
                const bd = projectData[b.id];
                if (!bd?.disciplines) return;
                const bp = calculateProgress(bd);
                bh += `<div class="building-section"><h2>üè¢ ${b.name} <span class="badge">${bp}%</span> <small>(${bd.levelCount || 1} n√≠veis)</small></h2>`;
                
                disciplineTemplates.forEach(dt => {
                    const disc = bd.disciplines[dt.id];
                    if (!disc) return;
                    bh += `<div class="disc-block"><div class="disc-header"><strong>${disc.code} - ${disc.fullName}</strong><span class="status ${disc.reengineeringStatus}">${getStatusText(disc.reengineeringStatus)}</span></div>`;
                    
                    modelTypes.forEach(mt => {
                        const md = disc.modelTypes?.[mt.id];
                        if (!md) return;
                        if (md.notApplicable) {
                            bh += `<div class="mt-block na"><span class="mt-code ${mt.id}">${mt.code}</span> N/A</div>`;
                        } else {
                            bh += `<div class="mt-block"><div class="mt-header"><span class="mt-code ${mt.id}">${mt.code}</span><span class="resp">${md.responsible || '-'}</span><span class="rev">IFC: ${md.revisionCountIfc || 0} | Doc: ${md.revisionCountDocs2d || 0}</span></div>`;
                            bh += `<table><thead><tr><th>N√≠vel</th><th>IFC</th><th>Compat.</th><th>Doc 2D</th><th>Liberado</th><th>Obs</th></tr></thead><tbody>`;
                            const levels = Object.entries(md.levels || {}).sort((a, b) => (a[1].order || 0) - (b[1].order || 0));
                            levels.forEach(([lid, level]) => {
                                const ph = level.phases || {};
                                bh += `<tr><td>${level.name}</td><td class="${ph.ifc}">${getStatusText(ph.ifc)}</td><td class="${ph.compatibility}">${getStatusText(ph.compatibility)}</td><td class="${ph.docs2d}">${getStatusText(ph.docs2d)}</td><td class="${ph.released}">${getStatusText(ph.released)}</td><td class="obs">${level.obs || '-'}</td></tr>`;
                            });
                            bh += `</tbody></table></div>`;
                        }
                    });
                    bh += `<div class="update">Atualizado: ${formatDate(disc.lastUpdate)}</div></div>`;
                });
                bh += `</div>`;
            });

            rw.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Relat√≥rio UNILA</title>
            <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background:#f5f5f5;color:#333;font-size:10px;padding:1rem}
            .building-section{background:white;border-radius:8px;padding:1rem;margin-bottom:1rem}h2{font-size:1rem;border-bottom:2px solid #FF6B00;padding-bottom:0.5rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
            h2 small{font-weight:normal;color:#666}.badge{background:#FF6B00;color:white;padding:0.2rem 0.5rem;border-radius:10px;font-size:0.75rem;margin-left:auto}
            .disc-block{border:1px solid #ddd;border-radius:6px;padding:0.5rem;margin-bottom:0.5rem}.disc-header{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem}
            .status{font-size:0.6rem;padding:0.1rem 0.3rem;border-radius:3px}.status.pending{background:#e0e0e0}.status.progress{background:#fff3cd;color:#856404}.status.approved{background:#d4edda;color:#155724}
            .mt-block{background:#f8f8f8;border-radius:4px;padding:0.4rem;margin-bottom:0.4rem}.mt-block.na{opacity:0.5;font-style:italic}
            .mt-header{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem}.mt-code{font-size:0.6rem;padding:0.1rem 0.3rem;border-radius:2px;color:white;font-weight:bold}
            .mt-code.mode{background:#2196F3}.mt-code.ajus{background:#9C27B0}.mt-code.reng{background:#FF6B00}.mt-code.asbt{background:#4CAF50}
            .resp{color:#666}.rev{margin-left:auto;color:#FF6B00;font-weight:bold}
            table{width:100%;border-collapse:collapse;font-size:0.65rem}th{background:#eee;padding:0.25rem;text-align:left}td{padding:0.25rem;border-bottom:1px solid #eee}
            td.pending{color:#666}td.progress{color:#856404;background:#fff8e1}td.issues{color:#C65D07;background:#fff3e0}td.approved{color:#155724;background:#e8f5e9}
            .obs{max-width:100px;font-size:0.6rem;color:#888}.update{font-size:0.6rem;color:#999;text-align:right;margin-top:0.3rem}
            .btn-print{position:fixed;top:0.5rem;right:0.5rem;background:#FF6B00;color:white;border:none;padding:0.4rem 0.8rem;border-radius:4px;cursor:pointer}
            @media print{.btn-print{display:none}}</style></head>
            <body><button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            <h1 style="text-align:center;margin-bottom:1rem;color:#FF6B00">üìä Relat√≥rio - Reengenharia UNILA</h1>
            <p style="text-align:center;margin-bottom:1rem;color:#666">Gerado em: ${now}</p>
            ${bh}</body></html>`);
            rw.document.close();
        }

        function renderBuildingTabs() {
            const c = document.getElementById('buildingFilter');
            if (!c) return;
            c.innerHTML = buildings.map(b => 
                `<button class="building-tab ${activeBuilding === b.id ? 'active' : ''}" onclick="setActiveBuilding('${b.id}')">${b.name}</button>`
            ).join('');
        }

        function renderBuildings() {
            const container = document.getElementById('buildingsContainer');
            if (!container) return;
            
            const building = buildings.find(b => b.id === activeBuilding);
            const bd = projectData[activeBuilding];
            if (!building || !bd) { container.innerHTML = ''; return; }
            
            const bp = calculateProgress(bd);
            const levelCount = bd.levelCount || building.defaultLevels;
            
            let html = `<div class="building-section">
                <div class="building-header">
                    <h2>üè¢ ${building.name}</h2>
                    <div class="building-config">
                        <label>N√≠veis:</label>
                        <input type="number" value="${levelCount}" min="1" max="50" onchange="updateLevelCount('${building.id}', this.value)">
                    </div>
                    <div class="building-progress">Progresso: <strong>${bp}%</strong></div>
                </div>
                <div class="disciplines-grid">`;

            disciplineTemplates.forEach((dt, di) => {
                const disc = bd.disciplines?.[dt.id];
                if (!disc) return;
                
                html += `<div class="discipline-card card-${disc.id}" style="animation-delay: ${di * 0.05}s">
                    <div class="card-header">
                        <div class="discipline-info">
                            <span class="discipline-code">${disc.code}</span>
                            <div class="discipline-name"><h3>${disc.name}</h3><span>${disc.fullName}</span></div>
                        </div>
                        <div class="reengineering-status">
                            <label>Reengenharia:</label>
                            <select class="${disc.reengineeringStatus}" onchange="updateReengineeringStatus('${building.id}', '${disc.id}', this.value)">
                                <option value="pending" ${disc.reengineeringStatus === 'pending' ? 'selected' : ''}>Pendente</option>
                                <option value="progress" ${disc.reengineeringStatus === 'progress' ? 'selected' : ''}>Em Andamento</option>
                                <option value="approved" ${disc.reengineeringStatus === 'approved' ? 'selected' : ''}>Conclu√≠do</option>
                            </select>
                        </div>
                    </div>
                    <div class="model-types-container"><div class="model-types-grid">`;

                modelTypes.forEach(mt => {
                    const md = disc.modelTypes?.[mt.id] || { notApplicable: false, responsible: '', levels: {}, revisionCountIfc: 0, revisionCountDocs2d: 0 };
                    const isNA = md.notApplicable;
                    const levels = Object.entries(md.levels || {}).sort((a, b) => (a[1].order || 0) - (b[1].order || 0));
                    
                    html += `<div class="model-type-card ${isNA ? 'not-applicable' : ''}">
                        <div class="model-type-header ${mt.id}">
                            <div class="model-type-title">
                                <span class="model-type-code ${mt.id}">${mt.code}</span>
                                <span class="model-type-name">${mt.name}</span>
                            </div>
                            ${mt.canBeNA ? `<div class="na-toggle"><label>N/A</label><input type="checkbox" ${isNA ? 'checked' : ''} onchange="toggleNotApplicable('${building.id}', '${disc.id}', '${mt.id}', this.checked)"></div>` : ''}
                        </div>
                        <div class="model-type-content ${isNA ? 'disabled' : ''}">
                            <div class="projetista-field">
                                <label>Projetista Respons√°vel</label>
                                <input type="text" value="${md.responsible || ''}" placeholder="${mt.defaultResponsible || 'Nome'}" 
                                    onchange="updateResponsible('${building.id}', '${disc.id}', '${mt.id}', this.value)" ${isNA ? 'disabled' : ''}>
                            </div>
                            <div class="niveis-container">`;

                    levels.forEach(([levelId, level], li) => {
                        const nivId = `niv-${building.id}-${disc.id}-${mt.id}-${levelId}`;
                        html += `<div class="nivel-item">
                            <div class="nivel-header" onclick="toggleNivel('${nivId}')">
                                <div class="nivel-name">
                                    <input type="text" value="${level.name}" onclick="event.stopPropagation()" 
                                        onchange="updateLevelName('${building.id}', '${disc.id}', '${mt.id}', '${levelId}', this.value)" ${isNA ? 'disabled' : ''}>
                                </div>
                                <span class="nivel-toggle ${li === 0 ? 'open' : ''}" id="${nivId}-toggle">‚ñº</span>
                            </div>
                            <div class="nivel-content ${li === 0 ? 'open' : ''}" id="${nivId}">
                                <div class="nivel-phases">`;
                        
                        phaseTemplates.forEach(phase => {
                            const status = level.phases?.[phase] || 'pending';
                            html += `<div class="nivel-phase">
                                <span class="nivel-phase-name">${phaseNames[phase]}</span>
                                <select class="${status}" onchange="updateLevelPhase('${building.id}', '${disc.id}', '${mt.id}', '${levelId}', '${phase}', this.value)" ${isNA ? 'disabled' : ''}>
                                    <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pendente</option>
                                    <option value="progress" ${status === 'progress' ? 'selected' : ''}>Em Andamento</option>
                                    <option value="issues" ${status === 'issues' ? 'selected' : ''}>Pend√™ncias</option>
                                    <option value="approved" ${status === 'approved' ? 'selected' : ''}>Conclu√≠do</option>
                                </select>
                            </div>`;
                        });

                        html += `</div>
                                <div class="nivel-obs">
                                    <label>Observa√ß√µes</label>
                                    <textarea placeholder="Observa√ß√µes..." 
                                        oninput="autoResizeTextarea(this)" 
                                        onchange="updateLevelObs('${building.id}', '${disc.id}', '${mt.id}', '${levelId}', this.value)" 
                                        ${isNA ? 'disabled' : ''}>${level.obs || ''}</textarea>
                                </div>
                            </div>
                        </div>`;
                    });

                    html += `</div>
                            <div class="revision-counters">
                                <div class="revision-counter" id="revision-ifc-${building.id}-${disc.id}-${mt.id}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                    <span class="revision-counter-label">IFC:</span>
                                    <span class="revision-counter-value">${md.revisionCountIfc || 0}</span>
                                    <button class="revision-counter-edit" onclick="editRevisionCount('${building.id}', '${disc.id}', '${mt.id}', 'ifc')" ${isNA ? 'disabled' : ''}>Editar</button>
                                </div>
                                <div class="revision-counter" id="revision-docs2d-${building.id}-${disc.id}-${mt.id}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                    <span class="revision-counter-label">Doc 2D:</span>
                                    <span class="revision-counter-value">${md.revisionCountDocs2d || 0}</span>
                                    <button class="revision-counter-edit" onclick="editRevisionCount('${building.id}', '${disc.id}', '${mt.id}', 'docs2d')" ${isNA ? 'disabled' : ''}>Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });

                html += `</div></div>
                    <div class="card-footer">
                        <div class="card-timestamp">√öltima atualiza√ß√£o: ${formatDate(disc.lastUpdate)}</div>
                    </div>
                </div>`;
            });

            html += `</div></div>`;
            container.innerHTML = html;

            // Auto-resize all textareas on load
            document.querySelectorAll('.nivel-obs textarea').forEach(ta => autoResizeTextarea(ta));
        }

        function render() { renderBuildingTabs(); renderBuildings(); updateStats(); }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!database) { document.getElementById('loadingText').textContent = 'Erro: Firebase n√£o inicializado'; return; }
            const timeout = setTimeout(() => {
                const lt = document.getElementById('loadingText');
                if (lt && lt.textContent.includes('Conectando')) lt.innerHTML = 'Timeout - Verifique regras do Firebase';
            }, 15000);
            try { await initializeData(); setupRealtimeListener(); clearTimeout(timeout); } 
            catch (e) { clearTimeout(timeout); document.getElementById('loadingText').innerHTML = 'Erro: ' + e.message; }
        });
    </script>
</body>
</html>
